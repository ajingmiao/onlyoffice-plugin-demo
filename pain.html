<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>ONLYOFFICE Connector 自检页</title>
  <style>
    html,body{height:100%;margin:0;display:flex;flex-direction:column;}
    #toolbar{padding:8px;background:#f0f0f0;border-bottom:1px solid #ccc;}
    #editor{flex:1;}
    button{margin-right:8px;padding:6px 12px;}
  </style>

  <script>
    // === 1) 这里切换脚本来源：Cloud ↔ 自建 DocumentServer ===
    // Cloud（你原来的）：
    //const SCRIPT_SRC = "https://7ef4abb5.docs.onlyoffice.com/web-apps/apps/api/documents/api.js";
    // 自建服务器（如需测试你自己的 DS，就改用下面这一行）：
     const SCRIPT_SRC = "http://222.187.11.98:8918/web-apps/apps/api/documents/api.js";

    // === 2) 测试用文档 URL（可换成你自己的） ===
    const DOC_URL = "https://temp2-1302420147.cos.ap-nanjing.myqcloud.com/test.docx";

    // === 3) 仅 Cloud 常见需要的 JWT 设置（自建 DS 通常不要这段） ===
    const USE_JWT = false; // 如果改用你自建 DS，多半要设为 false
    const JWT_HEADER_NAME = "AuthorizationJwt";
    const JWT_SECRET = "f134f023103d4933ad325e4ff51bc3d1"; // 演示值，按需替换或设 USE_JWT=false

    // ---- JWT 工具（Cloud 场景下常用）----
    function b64url(buf){return btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");}
    async function hmacSHA256(key,msg){
      const k=await crypto.subtle.importKey("raw",new TextEncoder().encode(key),{name:"HMAC",hash:"SHA-256"},false,["sign"]);
      const sig=await crypto.subtle.sign("HMAC",k,new TextEncoder().encode(msg));
      return b64url(sig);
    }
    async function makeJWT(secret,payload){
      const header={alg:"HS256",typ:"JWT"};
      const p1=btoa(JSON.stringify(header)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
      const p2=btoa(JSON.stringify(payload)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
      const sig=await hmacSHA256(secret,`${p1}.${p2}`);
      return `${p1}.${p2}.${sig}`;
    }

    // 动态加载 api.js，防止跨源 CSP 报错
    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s=document.createElement("script");
        s.src=src; s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
      });
    }
  </script>
</head>

<body>
  <div id="toolbar">
    <span id="status">⏳ 正在加载编辑器脚本...</span>
    <button id="btn-insert-text" disabled>插入文本</button>
    <button id="btn-insert-link" disabled>插入超链接</button>
    <button id="btn-insert-table" disabled>插入表格</button>
    <button id="btn-check" style="float:right">🔍 自检</button>
  </div>
  <div id="editor"></div>

  <script>
    let connector = null;

    const PLUGIN_GUID = 'asc.{6A1D2E30-1B7D-4A87-A2D7-4F3BB8A3C9E1}';

    (async function bootstrap(){
      try{
        await loadScript(SCRIPT_SRC);
        document.getElementById("status").innerText="⌛ 正在创建编辑器...";

        // 1) 组装配置
        const cfg = {
          documentType: "word",
          document: {
            fileType: "docx",
            title: "test.docx",
            url: DOC_URL,
            key: "demo-"+Date.now(),
            permissions: { edit: true }
          },
          editorConfig: {
            mode: "edit",
            callbackUrl: "https://example.com/callback-demo",
            customization: {
              plugins: {
                autostart: [ PLUGIN_GUID ]  // 自动启动插件，避免“插件未启用就发指令”的竞态
              }
            }
          },
          events: {
          // 插件通过 Common.Gateway.sendInfo -> 这里 onInfo 能收到
          onInfo: (e) => {
            if (e && e.command === 'pluginInitialized') {
              console.log('插件已就绪', e.data);
              // 发送命令 + 参数
              docEditor.serviceCommand('onlyoffice', '测试内容'); 
              // 也可发对象或更多参数（第二个参数起都被插件端整合到 data 里）
              docEditor.serviceCommand('highlight', { text: 'Hello', color: '#FFFF00' });
            }
          }
        }
        };

        // 2) Cloud 场景下常要签名。若是自建 DS，设 USE_JWT=false 跳过。
        if (USE_JWT){
          const token = await makeJWT(JWT_SECRET, cfg);
          cfg.token = token;
          cfg.headers = { [JWT_HEADER_NAME]: "Bearer "+token };
        }

        // 3) 创建编辑器
        window.docEditor = new DocsAPI.DocEditor("editor", cfg);
        console.log("docEditor 已创建:", !!window.docEditor);
      }catch(e){
        console.error("初始化失败:", e);
        document.getElementById("status").innerText="❌ 初始化失败，请看控制台。";
      }
    })();

    // 尝试获取 connector，并解锁按钮
    async function ensureConnector(){
      if (window.connector) { unlockUI("✅ 文档已就绪（沿用已有 connector）"); return; }

      try{
        let cc = window.docEditor && window.docEditor.createConnector
          ? window.docEditor.createConnector()
          : null;

        // 某些构建返回 Promise
        if (cc && typeof cc.then==="function") cc = await cc;
        // 某些构建把实例挂到属性上
        if (!cc || cc===true) cc = window.docEditor.connector || window.docEditor._connector || null;

        window.connector = cc;
        connector = cc;

        if (connector && (typeof connector.callCommand==="function" || typeof connector.executeMethod==="function")){
          unlockUI("✅ 文档已就绪，可用 connector");
        }else{
          document.getElementById("status").innerText="⚠️ 未获取到可用的 connector（大概率不含 Dev Pack / Developer 版）";
        }
      }catch(e){
        console.warn("获取 connector 失败：", e);
        document.getElementById("status").innerText="⚠️ 获取 connector 失败（详见控制台）";
      }
    }

    function unlockUI(text){
      document.getElementById("status").innerText = text;
      document.querySelectorAll("#toolbar button:not(#btn-check)").forEach(b=>b.disabled=false);
    }

    // ===== 自检按钮 =====
    document.getElementById("btn-check").onclick = () => {
      console.log("DocsAPI:", typeof DocsAPI);
      console.log("docEditor:", typeof window.docEditor, window.docEditor);
      console.log("createConnector:", window.docEditor && typeof window.docEditor.createConnector);
      console.log("connector:", window.connector);
      if (!window.docEditor) alert("docEditor 尚未创建。");
      else if (!window.docEditor.createConnector) alert("当前构建不包含 Automation API：createConnector 不存在（多半无 Dev Pack）。");
      else if (!window.connector) alert("支持 createConnector，但实例未成功创建（看控制台日志）。");
      else alert("connector 已存在，尝试操作按钮插入内容。");
    };

    // ===== 三个操作（优先 callCommand，回退 executeMethod）=====
    function ensureReady(){ if(!window.connector){ alert("文档尚未准备好或 connector 未创建。"); return false;} return true; }

    document.getElementById("btn-insert-text").onclick = async () => {
      if (!ensureReady()) return;
      try{
        const fn = function(){
          var d=Api.GetDocument();
          d.InsertText("【来自宿主的插入 @ "+(new Date()).toLocaleTimeString()+"】\n");
        };
        const r = window.connector.callCommand && window.connector.callCommand(fn,true);
        if (r && typeof r.then==="function") await r;
      }catch(e){
        console.warn("callCommand 失败：", e);
      }
      // 回退
      try{
        if (window.connector.executeMethod) window.connector.executeMethod("Paste", ["【回退插入】\n"]);
      }catch(e){ console.warn("executeMethod 回退失败：", e); }
    };

    document.getElementById("btn-insert-link").onclick = () => {
      if (!ensureReady()) return;
      const fn = function(){
        var d=Api.GetDocument();
        var p=Api.CreateParagraph();
        var t=Api.CreateRun(); t.AddText("访问 "); p.AddElement(t);
        var lr=Api.CreateRun(); lr.AddText("ONLYOFFICE 官网");
        var link=Api.CreateHyperlink("https://www.onlyoffice.com", lr);
        p.AddHyperlink(link);
        d.InsertContent([p]);
      };
      if (window.connector.callCommand) window.connector.callCommand(fn,true);
      else if (window.connector.executeMethod) window.connector.executeMethod("Paste", ["ONLYOFFICE: https://www.onlyoffice.com\n"]);
    };

    document.getElementById("btn-insert-table").onclick = () => {
      if (!ensureReady()) return;
      const fn = function(){
        var d=Api.GetDocument();
        var tbl=Api.CreateTable(2,2);
        tbl.GetRow(0).GetCell(0).GetContent().GetElement(0).AddText("A1");
        tbl.GetRow(0).GetCell(1).GetContent().GetElement(0).AddText("B1");
        tbl.GetRow(1).GetCell(0).GetContent().GetElement(0).AddText("A2");
        tbl.GetRow(1).GetCell(1).GetContent().GetElement(0).AddText("B2");
        d.InsertContent([tbl]);
      };
      if (window.connector.callCommand) window.connector.callCommand(fn,true);
      else if (window.connector.executeMethod) window.connector.executeMethod("Paste", ["A1\tB1\nA2\tB2\n"]);
    };
  </script>
</body>
</html>
