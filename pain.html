<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>ONLYOFFICE Connector è‡ªæ£€é¡µ</title>
  <style>
    html,body{height:100%;margin:0;display:flex;flex-direction:column;}
    #toolbar{padding:8px;background:#f0f0f0;border-bottom:1px solid #ccc;}
    #editor{flex:1;}
    button{margin-right:8px;padding:6px 12px;}
  </style>

  <script>
    // === 1) è¿™é‡Œåˆ‡æ¢è„šæœ¬æ¥æºï¼šCloud â†” è‡ªå»º DocumentServer ===
    // Cloudï¼ˆä½ åŸæ¥çš„ï¼‰ï¼š
    //const SCRIPT_SRC = "https://7ef4abb5.docs.onlyoffice.com/web-apps/apps/api/documents/api.js";
    // è‡ªå»ºæœåŠ¡å™¨ï¼ˆå¦‚éœ€æµ‹è¯•ä½ è‡ªå·±çš„ DSï¼Œå°±æ”¹ç”¨ä¸‹é¢è¿™ä¸€è¡Œï¼‰ï¼š
     const SCRIPT_SRC = "http://222.187.11.98:8918/web-apps/apps/api/documents/api.js";

    // === 2) æµ‹è¯•ç”¨æ–‡æ¡£ URLï¼ˆå¯æ¢æˆä½ è‡ªå·±çš„ï¼‰ ===
    const DOC_URL = "https://temp2-1302420147.cos.ap-nanjing.myqcloud.com/test.docx";

    // === 3) ä»… Cloud å¸¸è§éœ€è¦çš„ JWT è®¾ç½®ï¼ˆè‡ªå»º DS é€šå¸¸ä¸è¦è¿™æ®µï¼‰ ===
    const USE_JWT = false; // å¦‚æœæ”¹ç”¨ä½ è‡ªå»º DSï¼Œå¤šåŠè¦è®¾ä¸º false
    const JWT_HEADER_NAME = "AuthorizationJwt";
    const JWT_SECRET = "f134f023103d4933ad325e4ff51bc3d1"; // æ¼”ç¤ºå€¼ï¼ŒæŒ‰éœ€æ›¿æ¢æˆ–è®¾ USE_JWT=false

    // ---- JWT å·¥å…·ï¼ˆCloud åœºæ™¯ä¸‹å¸¸ç”¨ï¼‰----
    function b64url(buf){return btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");}
    async function hmacSHA256(key,msg){
      const k=await crypto.subtle.importKey("raw",new TextEncoder().encode(key),{name:"HMAC",hash:"SHA-256"},false,["sign"]);
      const sig=await crypto.subtle.sign("HMAC",k,new TextEncoder().encode(msg));
      return b64url(sig);
    }
    async function makeJWT(secret,payload){
      const header={alg:"HS256",typ:"JWT"};
      const p1=btoa(JSON.stringify(header)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
      const p2=btoa(JSON.stringify(payload)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
      const sig=await hmacSHA256(secret,`${p1}.${p2}`);
      return `${p1}.${p2}.${sig}`;
    }

    // åŠ¨æ€åŠ è½½ api.jsï¼Œé˜²æ­¢è·¨æº CSP æŠ¥é”™
    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s=document.createElement("script");
        s.src=src; s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
      });
    }
  </script>
</head>

<body>
  <div id="toolbar">
    <span id="status">â³ æ­£åœ¨åŠ è½½ç¼–è¾‘å™¨è„šæœ¬...</span>
    <button id="btn-insert-text" disabled>æ’å…¥æ–‡æœ¬</button>
    <button id="btn-insert-link" disabled>æ’å…¥è¶…é“¾æ¥</button>
    <button id="btn-insert-table" disabled>æ’å…¥è¡¨æ ¼</button>
    <button id="btn-check" style="float:right">ğŸ” è‡ªæ£€</button>
  </div>
  <div id="editor"></div>

  <script>
    let connector = null;

    const PLUGIN_GUID = 'asc.{6A1D2E30-1B7D-4A87-A2D7-4F3BB8A3C9E1}';

    (async function bootstrap(){
      try{
        await loadScript(SCRIPT_SRC);
        document.getElementById("status").innerText="âŒ› æ­£åœ¨åˆ›å»ºç¼–è¾‘å™¨...";

        // 1) ç»„è£…é…ç½®
        const cfg = {
          documentType: "word",
          document: {
            fileType: "docx",
            title: "test.docx",
            url: DOC_URL,
            key: "demo-"+Date.now(),
            permissions: { edit: true }
          },
          editorConfig: {
            mode: "edit",
            callbackUrl: "https://example.com/callback-demo",
            customization: {
              plugins: {
                autostart: [ PLUGIN_GUID ]  // è‡ªåŠ¨å¯åŠ¨æ’ä»¶ï¼Œé¿å…â€œæ’ä»¶æœªå¯ç”¨å°±å‘æŒ‡ä»¤â€çš„ç«æ€
              }
            }
          },
          events: {
          // æ’ä»¶é€šè¿‡ Common.Gateway.sendInfo -> è¿™é‡Œ onInfo èƒ½æ”¶åˆ°
          onInfo: (e) => {
            if (e && e.command === 'pluginInitialized') {
              console.log('æ’ä»¶å·²å°±ç»ª', e.data);
              // å‘é€å‘½ä»¤ + å‚æ•°
              docEditor.serviceCommand('onlyoffice', 'æµ‹è¯•å†…å®¹'); 
              // ä¹Ÿå¯å‘å¯¹è±¡æˆ–æ›´å¤šå‚æ•°ï¼ˆç¬¬äºŒä¸ªå‚æ•°èµ·éƒ½è¢«æ’ä»¶ç«¯æ•´åˆåˆ° data é‡Œï¼‰
              docEditor.serviceCommand('highlight', { text: 'Hello', color: '#FFFF00' });
            }
          }
        }
        };

        // 2) Cloud åœºæ™¯ä¸‹å¸¸è¦ç­¾åã€‚è‹¥æ˜¯è‡ªå»º DSï¼Œè®¾ USE_JWT=false è·³è¿‡ã€‚
        if (USE_JWT){
          const token = await makeJWT(JWT_SECRET, cfg);
          cfg.token = token;
          cfg.headers = { [JWT_HEADER_NAME]: "Bearer "+token };
        }

        // 3) åˆ›å»ºç¼–è¾‘å™¨
        window.docEditor = new DocsAPI.DocEditor("editor", cfg);
        console.log("docEditor å·²åˆ›å»º:", !!window.docEditor);
      }catch(e){
        console.error("åˆå§‹åŒ–å¤±è´¥:", e);
        document.getElementById("status").innerText="âŒ åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·çœ‹æ§åˆ¶å°ã€‚";
      }
    })();

    // å°è¯•è·å– connectorï¼Œå¹¶è§£é”æŒ‰é’®
    async function ensureConnector(){
      if (window.connector) { unlockUI("âœ… æ–‡æ¡£å·²å°±ç»ªï¼ˆæ²¿ç”¨å·²æœ‰ connectorï¼‰"); return; }

      try{
        let cc = window.docEditor && window.docEditor.createConnector
          ? window.docEditor.createConnector()
          : null;

        // æŸäº›æ„å»ºè¿”å› Promise
        if (cc && typeof cc.then==="function") cc = await cc;
        // æŸäº›æ„å»ºæŠŠå®ä¾‹æŒ‚åˆ°å±æ€§ä¸Š
        if (!cc || cc===true) cc = window.docEditor.connector || window.docEditor._connector || null;

        window.connector = cc;
        connector = cc;

        if (connector && (typeof connector.callCommand==="function" || typeof connector.executeMethod==="function")){
          unlockUI("âœ… æ–‡æ¡£å·²å°±ç»ªï¼Œå¯ç”¨ connector");
        }else{
          document.getElementById("status").innerText="âš ï¸ æœªè·å–åˆ°å¯ç”¨çš„ connectorï¼ˆå¤§æ¦‚ç‡ä¸å« Dev Pack / Developer ç‰ˆï¼‰";
        }
      }catch(e){
        console.warn("è·å– connector å¤±è´¥ï¼š", e);
        document.getElementById("status").innerText="âš ï¸ è·å– connector å¤±è´¥ï¼ˆè¯¦è§æ§åˆ¶å°ï¼‰";
      }
    }

    function unlockUI(text){
      document.getElementById("status").innerText = text;
      document.querySelectorAll("#toolbar button:not(#btn-check)").forEach(b=>b.disabled=false);
    }

    // ===== è‡ªæ£€æŒ‰é’® =====
    document.getElementById("btn-check").onclick = () => {
      console.log("DocsAPI:", typeof DocsAPI);
      console.log("docEditor:", typeof window.docEditor, window.docEditor);
      console.log("createConnector:", window.docEditor && typeof window.docEditor.createConnector);
      console.log("connector:", window.connector);
      if (!window.docEditor) alert("docEditor å°šæœªåˆ›å»ºã€‚");
      else if (!window.docEditor.createConnector) alert("å½“å‰æ„å»ºä¸åŒ…å« Automation APIï¼šcreateConnector ä¸å­˜åœ¨ï¼ˆå¤šåŠæ—  Dev Packï¼‰ã€‚");
      else if (!window.connector) alert("æ”¯æŒ createConnectorï¼Œä½†å®ä¾‹æœªæˆåŠŸåˆ›å»ºï¼ˆçœ‹æ§åˆ¶å°æ—¥å¿—ï¼‰ã€‚");
      else alert("connector å·²å­˜åœ¨ï¼Œå°è¯•æ“ä½œæŒ‰é’®æ’å…¥å†…å®¹ã€‚");
    };

    // ===== ä¸‰ä¸ªæ“ä½œï¼ˆä¼˜å…ˆ callCommandï¼Œå›é€€ executeMethodï¼‰=====
    function ensureReady(){ if(!window.connector){ alert("æ–‡æ¡£å°šæœªå‡†å¤‡å¥½æˆ– connector æœªåˆ›å»ºã€‚"); return false;} return true; }

    document.getElementById("btn-insert-text").onclick = async () => {
      if (!ensureReady()) return;
      try{
        const fn = function(){
          var d=Api.GetDocument();
          d.InsertText("ã€æ¥è‡ªå®¿ä¸»çš„æ’å…¥ @ "+(new Date()).toLocaleTimeString()+"ã€‘\n");
        };
        const r = window.connector.callCommand && window.connector.callCommand(fn,true);
        if (r && typeof r.then==="function") await r;
      }catch(e){
        console.warn("callCommand å¤±è´¥ï¼š", e);
      }
      // å›é€€
      try{
        if (window.connector.executeMethod) window.connector.executeMethod("Paste", ["ã€å›é€€æ’å…¥ã€‘\n"]);
      }catch(e){ console.warn("executeMethod å›é€€å¤±è´¥ï¼š", e); }
    };

    document.getElementById("btn-insert-link").onclick = () => {
      if (!ensureReady()) return;
      const fn = function(){
        var d=Api.GetDocument();
        var p=Api.CreateParagraph();
        var t=Api.CreateRun(); t.AddText("è®¿é—® "); p.AddElement(t);
        var lr=Api.CreateRun(); lr.AddText("ONLYOFFICE å®˜ç½‘");
        var link=Api.CreateHyperlink("https://www.onlyoffice.com", lr);
        p.AddHyperlink(link);
        d.InsertContent([p]);
      };
      if (window.connector.callCommand) window.connector.callCommand(fn,true);
      else if (window.connector.executeMethod) window.connector.executeMethod("Paste", ["ONLYOFFICE: https://www.onlyoffice.com\n"]);
    };

    document.getElementById("btn-insert-table").onclick = () => {
      if (!ensureReady()) return;
      const fn = function(){
        var d=Api.GetDocument();
        var tbl=Api.CreateTable(2,2);
        tbl.GetRow(0).GetCell(0).GetContent().GetElement(0).AddText("A1");
        tbl.GetRow(0).GetCell(1).GetContent().GetElement(0).AddText("B1");
        tbl.GetRow(1).GetCell(0).GetContent().GetElement(0).AddText("A2");
        tbl.GetRow(1).GetCell(1).GetContent().GetElement(0).AddText("B2");
        d.InsertContent([tbl]);
      };
      if (window.connector.callCommand) window.connector.callCommand(fn,true);
      else if (window.connector.executeMethod) window.connector.executeMethod("Paste", ["A1\tB1\nA2\tB2\n"]);
    };
  </script>
</body>
</html>
